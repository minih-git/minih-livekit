version: "3.9"

services:
  livekit:
    image: livekit/livekit-server:v1.9.7
    container_name: minih-livekit-server
    command: --config /livekit.yaml
    ports:
      # WebSocket / HTTP API
      - "7880:7880"
      # WebRTC 媒体流端口 (UDP + TCP)
      - "51000-51200:51000-51200/udp"
      - "51000-51200:51000-51200/tcp"
    volumes:
      # 映射 server 目录下的 livekit.yaml
      - ./livekit.yaml:/livekit.yaml:ro
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:7880" ]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - livekit_network

  redis:
    image: redis:7-alpine
    container_name: minih-livekit-redis
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - redis_data:/data
    networks:
      - livekit_network

  agent:
    image: minih-livekit-agent:latest
    restart: unless-stopped
    depends_on:
      livekit:
        condition: service_healthy
      redis:
        condition: service_started
    env_file:
      - ./.env
    environment:
      # 覆盖 .env 中的 URL，使用 docker 网络别名
      - LIVEKIT_URL=ws://livekit:7880
      # 确保 Token Server 监听 0.0.0.0 以便外部访问
      - HOST=0.0.0.0
      - TOKEN_SERVER_PORT=8080
    ports:
      - "8081:8080"
    volumes:
      # 挂载 recordings 目录以持久化录音
      - ./recordings:/app/recordings
    networks:
      - livekit_network

  app:
    build: ./app
    container_name: minih-livekit-app
    restart: unless-stopped
    ports:
      # HTTP Access
      - "3000:80"
    environment:
      # Internal backend service address for Nginx proxying
      - PUBLIC_API_PROXY_TARGET=http://agent:8080
      # LiveKit server address for the client (browser) to connect to
      - PUBLIC_LIVEKIT_URL=${PUBLIC_LIVEKIT_URL:-ws://localhost:7880}
      # Leave empty to use relative paths (proxying through Nginx /api)
      - PUBLIC_TOKEN_SERVER_URL=
    networks:
      - livekit_network

networks:
  livekit_network:
    name: minih_livekit_net
    driver: bridge

volumes:
  redis_data:
