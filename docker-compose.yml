version: "3.9"

services:
  livekit:
    image: livekit/livekit-server:v1.9.7
    container_name: minih-livekit-server
    command: --config /livekit.yaml
    ports:
      # WebSocket / HTTP API
      - "7880:7880"
      # WebRTC 媒体流端口 (UDP + TCP)
      - "51000-51200:51000-51200/udp"
      - "51000-51200:51000-51200/tcp"
    volumes:
      # 映射 server 目录下的 livekit.yaml
      - ./server/livekit.yaml:/livekit.yaml:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7880"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - livekit_network

  redis:
    image: redis:7-alpine
    container_name: minih-livekit-redis
    command: redis-server --save 60 1 --loglevel warning
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - livekit_network

  agent:
    container_name: minih-livekit-agent
    build:
      context: ./agent
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      livekit:
        condition: service_healthy
      redis:
        condition: service_started
    env_file:
      - ./agent/.env
    environment:
      # 覆盖 .env 中的 URL，使用 docker 网络别名
      - LIVEKIT_URL=ws://livekit:7880
      # 确保 Token Server 监听 0.0.0.0 以便外部访问
      - HOST=0.0.0.0
      - TOKEN_SERVER_PORT=8080
    ports:
      - "8080:8080"
    volumes:
      # 挂载 recordings 目录以持久化录音
      - ./agent/recordings:/app/recordings
    networks:
      - livekit_network

networks:
  livekit_network:
    name: minih_livekit_net
    driver: bridge

volumes:
  redis_data:
